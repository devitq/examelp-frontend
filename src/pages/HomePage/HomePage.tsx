import React, {useEffect, useState} from 'react';
import {useNavigate} from 'react-router-dom';

import {Box, Button, Card, Icon, Label, Link, Overlay, Spin, useToaster} from '@gravity-ui/uikit';
import {GraduationCap, Hammer} from '@gravity-ui/icons';

import {useStore} from '../../store/zustand';

import {getStrike} from '../../api/strike';

import {SubjectsContainer} from '../../components/SubjectsContainer';
import Styles from './HomePage.module.css';

export const HomePage: React.FC = () => {
    const store = useStore();
    const {add} = useToaster();

    const [strike, setStrike] = useState(null);
    const [taskCompletionDiagramLoading, setTaskCompletionDiagramLoading] = useState(true);
    const [strikeLoading, setStrikeLoading] = useState(true);

    useEffect(() => {
        document.title = `${import.meta.env.VITE_BRAND_NAME} | –ì–ª–∞–≤–Ω–∞—è`;

        if (store.isAuthenticated) {
            const fetchStrike = async () => {
                const result = await getStrike();
                if (result.success) {
                    setStrike(result.response.strike);
                } else {
                    add({
                        title: result.message,
                        theme: 'danger',
                    });
                }
                setStrikeLoading(false);
            };

            const timer = setTimeout(async () => {
                await fetchStrike();
                setTaskCompletionDiagramLoading(false);
            }, 500);

            return () => clearTimeout(timer);
        }
    }, []);

    if (!store.isAuthenticated) {
        return (
            <div className={Styles['landing-container']}>
                <div className={Styles['landing-header']}>
                    <GraduationCap className={Styles['landing-logo']} />
                    <h1>{import.meta.env.VITE_BRAND_NAME} Alpha</h1>
                    <p>
                        –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –≤–æ–∑–º–æ–∂–Ω–æ–µ –Ω–∞–ª–∏—á–∏–µ –±–∞–≥–æ–≤. –°–≤—è–∑–∞—Ç—å—Å—è:{' '}
                        <Link
                            href={`https://t.me/${import.meta.env.VITE_SUPPORT_BOT_USERNAME}`}
                            target="_blank"
                        >
                            @{import.meta.env.VITE_SUPPORT_BOT_USERNAME}
                        </Link>
                    </p>
                </div>
            </div>
        );
    }

    const navigate = useNavigate();

    return (
        <>
            <div className={Styles['stat-cards-container']}>
                <Box position="relative" className={Styles['diagram-box']}>
                    <Card className={Styles['diagram-card']} theme="normal" size="m">
                        {taskCompletionDiagramLoading ? null : (
                            <Label icon={<Icon size={16} data={Hammer} />} theme="warning" size="m">
                                –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
                            </Label>
                        )}
                        <Overlay visible={taskCompletionDiagramLoading}>
                            <Spin size="xl" />
                        </Overlay>
                    </Card>
                </Box>
                <Box position="relative" className={Styles['strike-box']}>
                    <Card className={Styles['strike-card']} theme="normal" size="m">
                        {strikeLoading ? null : (
                            <div className={Styles['strike-text']}>
                                <span className={Styles['strike-days']}>45</span>{' '}
                                <span
                                    className={Styles['strike-text-fire']}
                                    role="img"
                                    aria-label="flame"
                                >
                                    üî•
                                </span>
                            </div>
                        )}
                        <Overlay visible={strikeLoading}>
                            <Spin size="xl" />
                        </Overlay>
                    </Card>
                </Box>
            </div>
            <h1 className={Styles['my-subjects-title']}>–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã:</h1>
            <Card className={Styles['no-subjects-container']} theme="normal" size="m">
                <Button
                    className={Styles['buy_button']}
                    view="action"
                    size="l"
                    onClick={() => navigate('/subjects')}
                >
                    –í—ã–±—Ä–∞—Ç—å
                </Button>
            </Card>
            <br />
            <SubjectsContainer />
        </>
    );
};
